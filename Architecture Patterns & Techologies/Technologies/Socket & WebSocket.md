# Socket
**Socket - это API $=$ интерфейс программирования $\not=$ протокол** - это программный интерфейс для работы с сетью, предоставляемый операционной системой для того, чтобы предоставить программисту удобный способ использовать транспортные протоколы (TCP/UDP) без погружения в детали сетевой реализации.

<details>
<summary>Стек ISO/OSI</summary>

```txt
| Уровень 7 | Прикладной (Application)      | Ваше приложение                       |
| Уровень 6 | Представления (Presentation)  | (сериализация данных)                 |
| Уровень 5 | Сеансовый (Session)           | Socket API (управление соединением)   |
| Уровень 4 | Транспортный (Transport)      | TCP/UDP                               |
| Уровень 3 | Сетевой (Network)             | IP                                    |
| Уровень 2 | Канальный (Data Link)         | Ethernet/Wi-Fi                        |
| Уровень 1 | Физический (Physical)         | Кабель/радиоволны                     |
```
</details>

<details>
<summary>Стек TCP/IP</summary>

```txt
| Прикладной уровень    | Ваше приложение / пользовательские протоколы  |
| Транспортный уровень  | TCP/UDP (через Socket API)                    |
| Сетевой уровень       | IP                                            |
| Канальный уровень     | Ethernet/Wi-Fi и др.                          |
```
</details>

## Структура и особенности

Структура соединения:
1. Установка соединения (3-way handshake):
    ```txt
    Клиент → SYN → Сервер
    Клиент ← SYN-ACK ← Сервер
    Клиент → ACK → Сервер
    ```
2. Передача данных - поток байтов без встроенной структуры сообщений
3. Закрытие соединения (4-way handshake)

Особенности:
* Потоковость (streaming) - данные представляются как непрерывный поток байтов
* Надежность - гарантированная доставка, контроль переполнения
* Упорядоченность - данные приходят в порядке отправки
* Отсутствие встроенных границ сообщений - разработчик сам должен определять, где заканчивается одно сообщение и начинается другое
* Требует установки постоянного соединения (ключевое преимущество и ограничение одновременно)
* Блокирующие и неблокирующие режимы работы

# WebSocket
**WebSocket** - это протокол прикладного уровня (уровень 7 модели OSI), работающий поверх TCP, который обеспечивает полнодуплексную (full-duplex) двустороннюю связь через единое длительное соединение, инициируемое через механизм HTTP-апгрейда (HTTP Upgrade mechanism):
* Клиентский запрос на апгрейд: Специальный HTTP-запрос с заголовками `Upgrade: websocket`
* Серверное подтверждение: Ответ 101 Switching Protocols
* Установка WebSocket-канала: TCP-соединение переиспользуется для двусторонней связи
* Обмен фреймами: Структурированные данные в формате WebSocket-фреймов

<details>
<summary>Стек ISO/OSI</summary>

```txt
| Уровень 7 | Прикладной                    | WebSocket протокол + ваше приложение  |
| Уровень 6 | Представления                 | (сериализация данных, часто JSON)     |
| Уровень 5 | Сеансовый                     | WebSocket handshake (через HTTP)      |
| Уровень 4 | Транспортный (Transport)      | TCP (всегда)                          |
| Уровень 3 | Сетевой (Network)             | IP                                    |
| Уровень 2 | Канальный (Data Link)         | Ethernet/Wi-Fi                        |
| Уровень 1 | Физический (Physical)         | Кабель/радиоволны                     |
```
</details>

<details>
<summary>Стек TCP/IP</summary>

```txt
| Прикладной уровень    | WebSocket протокол (поверх HTTP) + приложение |
| Транспортный уровень  | TCP (всегда)                                  |
| Сетевой уровень       | IP                                            |
| Канальный уровень     | Ethernet/Wi-Fi и др.                          |
```
</details>

## Структура и особенности

Структура соединения:  
1. Установка соединения (Handshake):
    Клиент отправляет HTTP-запрос с заголовками:
    ```txt
    GET /chat HTTP/1.1
    Host: server.example.com
    Upgrade: websocket
    Connection: Upgrade
    Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==
    Sec-WebSocket-Version: 13
    ```
2. Сервер отвечает:  
    ```txt
    HTTP/1.1 101 Switching Protocols
    Upgrade: websocket
    Connection: Upgrade
    Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=
    ```


Структура фрейма WebSocket:
```txt
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-------+-+-------------+-------------------------------+
|F|R|R|R| opcode|M| Payload len |    Extended payload length    |
|I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |
|N|V|V|V|       |S|             |   (if payload len==126/127)   |
| |1|2|3|       |K|             |                               |
+-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +
|     Extended payload length continued, if payload len == 127  |
+ - - - - - - - - - - - - - - - +-------------------------------+
|                               |Masking-key, if MASK set to 1  |
+-------------------------------+-------------------------------+
| Masking-key (continued)       |          Payload Data         |
+-------------------------------- - - - - - - - - - - - - - - - +
:                     Payload Data continued ...                :
+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +
|                     Payload Data continued ...                |
+---------------------------------------------------------------+
```

Ключевые поля:
* FIN (1 бит) - указывает, является ли фрейм последним в сообщении
* Opcode (4 бита) - тип данных:  
    - 0x1: текстовые данные (UTF-8)  
    - 0x2: бинарные данные  
    - 0x8: закрытие соединения  
    - 0x9: ping  
    - 0xA: pong  
* Mask (1 бит) - маскировка (всегда 1 для клиента → сервер)
* Payload length - длина полезной нагрузки
* Masking-key - ключ маскировки (32 бита)
* Payload data - полезные данные


Особенности:
* Начинается как HTTP - проходит через прокси и брандмауэры
* Постоянное соединение - один TCP-коннекшн на весь сеанс
* Двусторонняя связь - клиент и сервер могут отправлять данные в любое время
* Фреймовая структура - четкие границы сообщений
* Поддержка ping/pong - механизм keep-alive
* Маскировка данных - безопасность от кешированных атак
* Поддержка текстовых и бинарных данных
* Не требует установки постоянного соединения (ключевое преимущество):
    Двусторонняя связь (full-duplex) поверх одного HTTP-соединения, без необходимости постоянных опросов.

# Socket v/s WebSocket

**Сравнительная таблица**
| Аспект                | Обычный Socket                | WebSocket |
|-----------------------|-------------------------------|-|
| Уровень               | Транспортный API              | Прикладной протокол |
| Инициализация	        | Прямое TCP/UDP соединение	    | Через HTTP-апгрейд |
| Протокол	            | TCP, UDP или другие           | Только поверх TCP |
| Структура данных      | Поток байтов (без границ)	    | Фреймы с границами сообщений |
| Двусторонняя связь    | Да, но нужно реализовывать    | Встроенная в протокол |
| Совместимость с HTTP  | Нет                           | Да, начинается как HTTP |
| Браузерная поддержка  | Нет (кроме через плагины)     | Нативная во всех современных |
| Сложность реализации  | Высокая (нужен свой протокол) | Средняя (протокол уже определен) |

**Ключевое отличие в контексте сеансов:**
| Аспект                            | TCP Socket (через Socket API)       | WebSocket |
|-----------------------------------|-------------------------------------|-|
| Тип сеанса                        | Транспортный сеанс (TCP)            | Прикладной сеанс поверх TCP |
| Длительность                      | Может быть любой                    | Может быть любой |
| Структура                         | Простой поток байтов                | Структурированные фреймы с типами |
| Инициация                         | Прямое TCP-соединение               | Через HTTP, затем апгрейд |
| В рамках одного TCP-соединения    | Один сеанс = одно TCP соединение    | Можно повторно использовать (теоретически) |

**Использование Socket:**
* Низкоуровневые сетевые коммуникации - основа практически всех сетевых протоколов
* Клиент-серверные приложения - базы данных (MySQL, PostgreSQL), почтовые серверы (SMTP/POP3/IMAP)
* Файловые протоколы - FTP, SFTP
* Удаленное управление - SSH, Telnet
* Игры - MMO, шутеры (часто на UDP для минимальной задержки)
* Потоковое видео/аудио - RTSP, VoIP (SIP)
* P2P-сети - торренты, блокчейн

**Использование WebSocket:**
* Веб-приложения реального времени - чаты, уведомления, коллаборативные редакторы
* Онлайн-игры в браузере - многопользовательские игры
* Биржевые тикеры и финансовые данные - постоянный поток котировок
* Стриминг данных - дашборды мониторинга, IoT-панели
* Удаленный рабочий стол через браузер
* Совместное редактирование документов - Google Docs, Figma