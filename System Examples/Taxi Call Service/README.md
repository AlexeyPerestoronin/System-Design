# Taxi Call Service

Сервис заказа такси.

## Функциональные требования
* Клиент может заказать такси к указанному (или текущему) местоположению и указать точку назначения.
* Заказ такси возможен только с мобильных устройств, но статистику использования можно посмотреть и через браузер.
* Мобильное приложение-клиент отслеживает водителя такси и уведомляет пользователя о том, когда такси скоро подъедет или о другой ситуации, требующей внимания со стороны пользователя.
* Приложение отслеживает поездку на всём её протяжении.
* Есть система рейтинга: водители с большим рейтингом получают пассажиров с большим рейтингом, и наоборот.
* Есть система тарифов: стандарт, бизнес и премиум.

## НеФункциональные требования
* Система должна работать по всему миру (Европа, Америка, Азия).
* Система должна обладать низкими задержками (low latency).
* 100.000 активных водителей
* 10.000.000 активных пользователей
    * БД: $(1.000.000users + 100.000drivers) * 10MB \simeq 10TB$ - приблизительный объём хранимой информации о пользователях системы
* DAU ~ 1.000.000 поездок
    * БД: $1.000.000drives * 10MB \simeq 10TB$ ~ приблизительный объём новых данных Системы о совершённых поездках за один день

![](./taxi%20call%20service.drawio.png)

## Happy Path:
1. Пользователь подключается к Системе через приложение и делает заказ такси назначая начальную и конечную точку
2. Система формирует заказ клиента:
    - формирует оптимальный маршрут и предварительную стоимость поездки
    - ищет доступных водителей в зоне доступа клиента
    - ранжирует доступных водителей по рейтингу, согласуя это с фактическим рейтингом клиента и запускает опрос среди выбранных водителей
    - дожидается подтверждения от водителя
    - начинает поездку
3. Сопровождение поездки:
    - отслеживание положения водителя и клиента на протяжении всего пути
    - фиксация ключевых момент поездки через уведомления:
        - водитель подъезжает
        - водитель начал поездку
        - водитель завершает поездку
        - поездка завершена
4. Завершение поездки:
    - проведение оплаты за поездку
    - пересчёт рейтинга водителя и пассажира

# System Services
## Entry Point
Сервис внешнего доступа к Системе:
* **System Gateway**:
    * выдаёт временные JWT токены зарегистрированным пользователям
* **Load Balancer**:
    * администрирует нагрузку на внутреннюю часть Системы:
        * связывает водителей с наиболее близкими серверами
        * перенаправляет запросы активного пассажира на управляющий сервер связанного с ним водителя
    * защищает от DDoS атаки
* **API Gateway**:
    * управляет API системы
        * следит за используемой версией клиента и осуществляет конвертацию, если нужно
    * формирует на основе API запросы в Message Queue в соответствующую очередь
    * отправляет ответы пользователям
    * может напрямую связываться с сервисом Drivers Pool для передачи полученных от водителей координат их фактического местоположения
    * может напрямую связываться с сервисом Order Execution на время исполнения конкретной поездки

## Message Queue
Глобальная  очередь сообщений системы с возможностью отслеживания статуса сообщений с нотификацией отправителя.

## Business Logic Services:
### Users
* регистрирует новых пользователей
* управляет информацией зарегистрированных пользователей

### Drives Pool
* агрегирует координаты активных водителей:
    * водитель-клиент самостоятельно посылает свои координаты раз в 5 секунд
* предоставляет список активных водителей в определённом радиусе

### Order Execution
* отслеживает исполнение готового заказа:
    * проверяет совпадение координат водителя и клиента во время поездки
    * уведомляет клиента о действиях водителя
    * уведомляет водителя о действиях клиента
* решает возникающие проблемы:
    * перестройка маршрута
* уведомляет систему о факте завершения поездки

### Way Creation
* формирует маршрут поездки (несколько вариантов)
* считает предварительную стоимость поездки

### Order Creation
* формирует заказ на поездку

### Order Finishing
* считает фактическое значение стоимости поездки
* проводит оплату завершённой поездки
* пересчитывает рейтинги пользователя и водителя

### Maps
* управляет картами для сервиса
    * обновляет карты по необходимости (раз в час)
* имеет локальный cache карты
    * NoSQL → DocumentOriented → MongoDB

### Monitoring & Statistics
* агрегирует статистику работы со всех сервисов Системы
    * NoSQL + WideColumn → ClickHouse
    * раз в день выгружает данные в Log DB
* формирует статистику по запросу от пользователей

## Data Base Services:
### Maps DB
Хранит данные о картах местности:
* PostGIS 

### Users DB
Хранит данные о пользователях системы:
* SQL - PostgresSQL
* Sharding by UserID

### Orders DB
Хранит данные о заказах Системы:
* SQL - PostgresSQL
* Sharding by OrderID

### Log DB
Хранит лог-данные о работе Системы за всё время её существования:
* Hadoop